#!/bin/sh
# kFreeBSD do not accept scripts as interpreters, using #!/bin/sh and sourcing.
if [ true != "$INIT_D_SCRIPT_SOURCED" ] ; then
    set "$0" "$@"; INIT_D_SCRIPT_SOURCED=true . /lib/init/init-d-script
fi
### BEGIN INIT INFO
# Provides:          hived
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start the Hive Runner
# Description:       The Hive Runner is part of the Hive CI test
#                    automation framework. For more details see
#                    https://bbc.github.io/hive-ci/
### END INIT INFO

# Author: Joe Haig <joe.haig@bbc.co.uk>

###############################################################################
# CONFIGURATION
#
# Home directory of the Hive
HIVE_HOME=###HIVE_HOME###
# User to run the Hive. Must have access to Ruby as configured ab obove
USER=###USER###
###############################################################################

DESC="Hive Runner"
LOG_DIRECTORY=/var/log/hived
SCRIPT=$HIVE_HOME/start_hive.sh
if [ ! -d $LOG_DIRECTORY ]
then
  mkdir -p $LOG_DIRECTORY
  chown $USER $LOG_DIRECTORY
fi

PID=/var/run/hived.pid

sig() {
  test -s "$PID" && kill -$1 `cat $PID`
}

case "$1" in
  start)
    log_daemon_msg "Starting Hive Runner" "hived" || true
    sig 0 && log_daemon_msg "Already running" && exit 0
    sudo -i -u $USER LOG_DIRECTORY=$LOG_DIRECTORY $SCRIPT > $PID
    ;;
  stop)
    log_daemon_msg "Stopping Hive Runner" "hived" || true
    sig 9 && rm $PID && exit 0
    log_daemon_msg "Not running"
    ;;
  #reload)
  #  echo "TODO: reload"
  #  ;;
  restart)
    echo "TODO: restart"
    log_daemon_msg "Stopping Hive Runner" "hived" || true
    sig 9 && rm $PID
    log_daemon_msg "Starting Hive Runner" "hived" || true
    sudo -i -u $USER $SCRIPT > $PID
    ;;
  status)
    if sig "USR1"
    then
      telnet localhost 9999 2> /dev/null
      log_daemon_msg "Status: running ("`cat $PID`")"
      exit 1
    else
      log_daemon_msg "Status: not running"
      exit 0
    fi
    ;;
  *)
    log_action_msg "Usage: /etc/init.d/hived {start|stop|restart|status}" || true
    exit 1
esac

exit 0

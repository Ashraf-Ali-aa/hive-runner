#!/usr/bin/env ruby

$LOAD_PATH << File.expand_path('../../lib', __FILE__)
$PROGRAM_NAME = 'HIVE'

require 'socket'
require 'hive/daemon_helper'

# Communication with daemon launcher
comm = TCPServer.open(9999)
Signal.trap('INFO') do
  client = comm.accept
  Hive::DaemonHelper.controllers.each do |c|
    client.puts "Using #{c.class.name.split('::').last.downcase} controller"
  end
  workers = Hive::DaemonHelper.workers
  client.puts "Number of workers: #{workers.length}"
  if workers.length > 0
    client.puts 'Workers:'
    workers.each do |w|
      client.puts " - #{w.type} worker [pid #{w.pid}]"
    end
  end
  client.close
end

at_exit do
  # TODO: This is being called for each worker. How can I stop this?
  workers = Hive::DaemonHelper.workers
  workers.each do |w|
    w.stop
  end
end

# Initialise
Hive::DaemonHelper.instantiate_controllers
# Hive::DaemonHelper.check_workers

# Execution loop
Hive::LOG.info('Starting execution loop')
Hive::DaemonHelper.run

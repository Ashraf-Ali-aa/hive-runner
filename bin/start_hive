#!/usr/bin/env ruby

$LOAD_PATH << File.expand_path('../../lib', __FILE__)

require 'socket'
require 'hive/daemon_helper'

$PROGRAM_NAME = Hive::DAEMON_NAME

# Communication with daemon launcher
comm = TCPServer.open(ENV.fetch('HIVE_COMM_PORT', 9999).to_i)
Signal.trap('USR1') do
  client = comm.accept
  Hive::DaemonHelper.controllers.each do |c|
    client.puts "Using #{c.class.name.split('::').last.downcase} controller"
  end
  workers = Hive::DaemonHelper.workers
  client.puts "Number of workers: #{workers.length}"
  if workers.length > 0
    client.puts 'Workers:'
    workers.each do |w|
      client.puts " - #{w.type} worker [pid #{w.pid}]"
    end
  end
  client.close
end

# Initialise
Hive::DaemonHelper.instantiate_controllers

# Execution loop
Hive::LOG.info('Starting execution loop')
Hive::DaemonHelper.run

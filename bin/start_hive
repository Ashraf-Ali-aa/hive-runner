#!/usr/bin/env ruby

require 'pathname'
ENV['BUNDLE_GEMFILE'] ||= File.expand_path(
  '../../Gemfile',
  Pathname.new(__FILE__).realpath
)

$LOAD_PATH << File.expand_path('../../lib', __FILE__)

require 'socket'
require 'hive'

$PROGRAM_NAME = Hive::DAEMON_NAME

# Communication with daemon launcher
comm_port = ENV.fetch('HIVE_COMM_PORT', 9999).to_i
comm = TCPServer.open(comm_port)
Signal.trap('USR1') do
  client = comm.accept
  Hive.register.controllers.each do |c|
    client.puts "Using #{c.class.name.split('::').last.downcase} controller"
  end
  devices = Hive.register.devices
  client.puts "Number of devices: #{devices.length}"
  if devices.length > 0
    client.puts 'Devices:'
    devices.each do |d|
      if d.claimed?
        client.puts " - #{d.identity} [Claimed]"
      else
        client.puts " - #{d.identity} [worker pid #{d.worker_pid}]"
      end
    end
  end
  client.close
end

# Initialise
Hive.register.instantiate_controllers

# Execution loop
Hive::logger.info('*** HIVE STARTING ***')
Hive::logger.info('Starting execution loop')
Hive.register.run
